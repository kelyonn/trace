<!DOCTYPE html>
<html>
<head>
    <title>Trace - Immersive Analytics</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
</head>
<body>
    <a-scene>
        <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
        <a-sky color="#ECECEC"></a-sky>
        <a-entity camera looks-controls position="0 1.6 5" cursor="rayOrigin: mouse" raycaster="objects: .data-box"><a-text
        id="tooltip"
        value=""
        position="0 -0.5 -1"
        align="center"
        color="#FFFFFF"
        visible="false">
        </a-text>
        </a-entity>
    </a-scene>

    <script>
        window.onload = function () {
            const API_URL = 'http://localhost:3000/api/data'; // Make sure your backend runs here

            fetch(API_URL)
                .then(response => response.json())
                .then(data => {
                    console.log('Data successfully fetched from server:', data);
                    renderCube(data);
                })
                .catch(error => {
                    console.error('There was a problem fetching the data:', error);
                });
        };

        function renderCube(salesData) {
            const scene = document.querySelector('a-scene');

            salesData.forEach(dataPoint => {
                const box = document.createElement('a-entity');
                box.classList.add('data-box');
                const boxHeight = dataPoint.sales / 100;
                const xPosition = dataPoint.product === 'A' ? -1 : 1;
                const zPosition = dataPoint.region === 'North' ? -3 : -5;
                const yPosition = boxHeight / 2;
                const boxColor = dataPoint.year === 2023 ? '#EF2D5E' : '#4CC3D9';
                

                // Set geometry with dynamic height
                box.setAttribute('geometry', {
                    primitive: 'box',
                    width: 0.9,
                    height: boxHeight,
                    depth: 0.9
                });

                // Set material color
                box.setAttribute('material', 'color', boxColor);

                // Set position
                box.setAttribute('position', `${xPosition} ${yPosition} ${zPosition}`);
                
                box.dataset.sales = dataPoint.sales;
                box.dataset.region = dataPoint.region;
                box.dataset.product = dataPoint.product;

                const tooltipText = document.querySelector('#tooltip');

                box.addEventListener('mouseenter', function (event) {
                event.target.setAttribute('opacity', 0.7);
                tooltipText.setAttribute('value', `Region: ${event.target.dataset.region}\nProduct: ${event.target.dataset.product}\nSales: ${event.target.dataset.sales}`);
                tooltipText.setAttribute('visible', true);
                });

                box.addEventListener('mouseleave', function (event) {
                event.target.setAttribute('opacity', 1.0);
                tooltipText.setAttribute('visible', false);
                });

                // Append box to the scene
                scene.appendChild(box);
            });
        }
    </script>
</body>
</html>
